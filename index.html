<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pubali Live Inventory System</title>
    
    <style>
        :root {
            --primary: #006a4e;
            --accent: #f39c12;
            --light-bg: #f4fdf9;
            --border: #c8d6d1;
            --text: #2d3436;
            --overdue-bg: #ffe0e0;
            --done-text: #27ae60;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: var(--light-bg); display: flex; flex-direction: column; height: 100vh; color: var(--text); }

        /* HEADER */
        header {
            background: white; border-bottom: 3px solid var(--primary); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-wrap: wrap; gap: 10px;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand img { height: 40px; } 
        .brand h1 { margin: 0; font-size: 18px; color: var(--primary); text-transform: uppercase; }
        .brand small { color: #666; display: block; font-size: 11px; }
        .top-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* MOBILE TOGGLE */
        .menu-toggle { display: none; background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 18px; }

        /* LAYOUT */
        .container { flex: 1; display: flex; overflow: hidden; }
        
        /* SIDEBAR */
        aside { 
            width: 260px; background: #004d38; color: white; display: flex; flex-direction: column; 
            border-right: 1px solid #003829; transition: transform 0.3s ease;
        }
        .sb-header { padding: 15px; background: rgba(0,0,0,0.2); text-align: center; }
        .sb-header h3 { margin: 0; font-size: 16px; color: var(--accent); }
        .table-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .table-list li { 
            padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; 
            transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .table-list li:hover { background: rgba(255,255,255,0.1); }
        .table-list li.active { background: var(--light-bg); color: var(--primary); border-left: 5px solid var(--accent); font-weight: bold; }
        
        .add-table-btn { width: 90%; margin: 10px auto; padding: 8px; background: var(--accent); border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 4px; display: block; }

        /* MAIN AREA */
        main { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .toolbar { 
            display: flex; gap: 8px; margin-bottom: 15px; background: white; padding: 10px; 
            border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; align-items: center;
        }
        .toolbar h3 { margin: 0; color: var(--primary); font-size: 16px; }
        .search-box { flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* DATA TABLE */
        .table-wrapper { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 6px; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { 
            background: var(--primary); color: white; padding: 10px 8px; text-align: left; position: sticky; top: 0; z-index: 10; 
            white-space: nowrap; cursor: pointer; font-size: 13px;
        }
        th:last-child { cursor: default; }
        td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 13px; }
        tr:hover { background-color: #f1f8f6; }
        .sort-indicator { margin-left: 5px; font-size: 0.8em; }

        .topic-truncate {
            display: block; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; color: var(--primary); font-weight: 500;
        }
        .topic-truncate:hover { text-decoration: underline; color: #003829; }

        .Status-done { color: var(--done-text); font-weight: bold; }
        .overdue-row { background-color: var(--overdue-bg) !important; color: #880000; }
        .reminder-link { color: #d35400; font-weight: bold; cursor: pointer; text-decoration: underline; }

        /* BUTTONS */
        .btn { 
            padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; 
            font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; 
            gap: 5px; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* ACTION ICONS */
        .action-icons { display: flex; gap: 8px; align-items: center; justify-content: center; }
        .icon-btn { border: none; background: none; cursor: pointer; font-size: 16px; padding: 2px; transition: transform 0.2s; }
        .icon-btn:hover { transform: scale(1.2); }

        /* FOOTER */
        footer { 
            background: var(--primary); color: white; text-align: center; padding: 8px 10px; 
            font-size: 11px; border-top: 3px solid var(--accent); display: flex; 
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .footer-logo { height: 18px; vertical-align: middle; margin-right: 5px; filter: brightness(0) invert(1); }

        /* MODALS */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px);
            padding: 10px;
        }
        .modal-box { 
            background: white; width: 500px; max-width: 95%; border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; 
            flex-direction: column; max-height: 90vh;
        }
        .modal-header { 
            background: var(--primary); color: white; padding: 12px 15px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; font-size: 16px; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 12px 15px; background: #f9f9f9; text-align: right; border-top: 1px solid #eee; }

        .detail-table { width: 100%; border-collapse: collapse; }
        .detail-table th { background: #eee; color: #333; padding: 8px; border: 1px solid #ddd; width: 35%; text-align: left; font-size: 12px; }
        .detail-table td { padding: 8px; border: 1px solid #ddd; word-break: break-word; white-space: pre-wrap; font-size: 12px; }
        
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        
        .admin-only { display: none !important; }
        
        .loading { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 30px; border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;
        }
        .spinner { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .config-modal { background: #fffbf0; padding: 15px; border-radius: 6px; border: 2px solid var(--accent); margin-bottom: 15px; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .brand h1 { font-size: 14px; }
            .brand small { font-size: 10px; }
            .brand img { height: 35px; }
            
            .menu-toggle { display: block; }
            
            aside {
                position: fixed; left: 0; top: 0; bottom: 0; z-index: 999;
                transform: translateX(-100%);
            }
            aside.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.3); }
            
            main { padding: 10px; }
            
            .toolbar { padding: 8px; }
            .toolbar h3 { font-size: 14px; width: 100%; }
            .search-box { min-width: 100%; }
            
            .btn { padding: 6px 10px; font-size: 11px; }
            
            th, td { padding: 6px 4px; font-size: 11px; }
            .topic-truncate { max-width: 150px; }
            
            .action-icons { gap: 5px; }
            .icon-btn { font-size: 14px; }
            
            footer { font-size: 9px; padding: 5px; }
            footer > div { font-size: 9px; }
            .footer-logo { height: 15px; }
            
            .modal-box { max-width: 98%; }
            .modal-body { padding: 10px; }
            
            table { min-width: 500px; }
        }

        @media (max-width: 480px) {
            .top-actions { width: 100%; justify-content: space-between; }
            .btn { flex: 1; justify-content: center; }
            
            .table-list li { padding: 10px 15px; font-size: 13px; }
            
            th, td { font-size: 10px; padding: 5px 3px; }
        }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div style="text-align:center; color:var(--primary); font-weight:bold;">Loading Data...</div>
    </div>

    <!-- Admin Only Config Modal -->
    <div id="configScreen" class="modal-overlay admin-only">
        <div class="modal-box">
            <div class="modal-header">
                <h3>üîß Supabase Configuration (Admin Only)</h3>
            </div>
            <div class="modal-body">
                <div class="config-modal">
                    <h4 style="margin-top:0; color:var(--primary);">Update Configuration</h4>
                    <p style="font-size:12px; color:#666;">Current config is working. Only change if needed:</p>
                    
                    <div class="input-group">
                        <label>Supabase Project URL</label>
                        <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                    </div>
                    
                    <div class="input-group">
                        <label>Supabase Anon Key</label>
                        <input type="text" id="supabaseKey" placeholder="eyJhbGc...">
                    </div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="saveSupabaseConfig()">‚úì Save Configuration</button>
                    <button class="btn btn-outline" style="width:100%; margin-top:5px;" onclick="closeModal('configScreen')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <div class="brand">
            <img src="banklogo.gif" alt="Pubali Bank Logo" onerror="this.style.display='none'">
            <div>
                <h1>Daily Task And Inventory</h1>
                <small>Live Database System</small>
            </div>
        </div>
        <div class="top-actions admin-only"> 
            <button class="btn btn-outline" onclick="exportData()">‚¨á Backup</button>
            <button class="btn btn-danger" onclick="openConfigModal()">‚öô Config</button>
        </div>
    </header>

    <div class="container">
        <aside id="sidebar">
            <div class="sb-header">
                <h3>TABLE LIST</h3>
            </div>
            <button class="add-table-btn admin-only" onclick="openAddTableModal()">+ New Table</button>
            <ul class="table-list" id="tableList"></ul>
        </aside>

        <main>
            <div id="welcomeScreen" style="text-align: center; margin-top: 50px; color: #aaa;">
                <h2 style="font-size: 18px;">Select a table to view details</h2>
            </div>

            <div id="tableContent" style="display: none; height: 100%; flex-direction: column;">
                <div class="toolbar">
                    <h3 id="activeTableName">Table Name</h3>
                    <input type="text" id="searchInput" class="search-box" placeholder="Search data..." onkeyup="renderRows()">
                    <button class="btn btn-primary admin-only" onclick="openRowModal('add')">+ Add Row</button>
                    <button class="btn btn-danger admin-only" onclick="deleteCurrentTable()">Delete Table</button>
                </div>

                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead><tr id="tableHeadRow"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <footer>
        <div onclick="askAdminPass()" style="cursor: pointer;" title="Click to Login as Admin">
            <img src="banklogo.gif" class="footer-logo" alt="Logo" onerror="this.style.display='none'">
            <span>Developed by Switching CMS & Risk Management</span>
        </div>
        <div>
            Status: <span id="StatusIndicator" style="color: #81ecec;">View Mode</span>
        </div>
    </footer>

    <!-- View Modal -->
    <div class="modal-overlay" id="viewModal">
        <div class="modal-box" style="width: 700px;">
            <div class="modal-header">
                <h3>Task Full Details</h3>
                <button style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" onclick="closeModal('viewModal')">√ó</button>
            </div>
            <div class="modal-body">
                <table class="detail-table">
                    <tbody id="viewDetailsBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('viewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div class="modal-overlay" id="mainModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle">Entry</h3>
                <button style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" onclick="closeModal('mainModal')">√ó</button>
            </div>
            <div class="modal-body" id="modalForm"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('mainModal')">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Reminder History</h3>
                <button style="background:none; border:none; color:white; font-size:20px; cursor:pointer;" onclick="closeModal('reminderModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="admin-only" style="background: #effbf5; padding: 12px; border-radius: 6px; border: 1px solid #c8d6d1; margin-bottom: 12px;">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--primary); font-size:13px;">Add New Reminder</div>
                    <div class="input-group"><label>Date</label><input type="date" id="remDate"></div>
                    <div class="input-group"><label>Contact With</label><input type="text" id="contactWith"></div>
                    <div class="input-group"><label>Update Comment</label><textarea id="remComment" rows="2"></textarea></div>
                    <button class="btn btn-accent" style="width:100%" onclick="addNewReminder()">+ Add Reminder</button>
                </div>
                <div id="reminderListContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========== FIXED SUPABASE CONFIGURATION ==========
        const SUPABASE_CONFIG = {
            url: 'https://afooeyfvzfhlcxlufnyw.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFmb29leWZ2emZobGN4bHVmbnl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MDA1MjEsImV4cCI6MjA4MTI3NjUyMX0.L8IxAmBZ_q5rrWjUUFsDzYfE1-1ci4dyHZvAN86naEw'
        };

        const TABLE_CONFIG = {
            "Pending Task SDD": {
                columns: ["SL No.", "Topics", "Last Reminder", "Status"], 
                truncate: "Topics"
            },
            "Pending Task Cynergon": {
                columns: ["SL NO.", "TASK DETAILS", "LAST REMINDER", "STATUS"],
                truncate: "TASK DETAILS"
            }
        };

        const STARTUP_DATA = {
            "Pending Task SDD": [
                {"SL No.": 1, "Topics": "Update Security Protocols for API Gateway and ensure all firewalls are synced with the new policy server.", "Requested Via": "Mail", "Requested On": "2025-12-01", "Requested By": "Foyzar", "Last Reminder": [{date: "2025-12-05", comment: "Initial reminder sent.", contactWith: "Admin"}], "Status": "Pending", "Comments": "Waiting for approval"},
                {"SL No.": 2, "Topics": "Review and update disaster recovery plan documentation for core banking systems.", "Requested Via": "Meeting", "Requested On": "2025-11-20", "Requested By": "Sanjib", "Last Reminder": [{date: "2025-11-21", comment: "Started initial draft.", contactWith: "IT Head"}], "Status": "In Progress", "Comments": "Draft is 50% complete"}
            ],
            "Pending Task Cynergon": [
                {"SL NO.": 1, "TASK DETAILS": "Server Migration for Database Cluster to new localized instance and verify integrity of backup data.", "REQUESTED VIA": "Email", "REQUESTED BY": "Nabila", "REQUESTED ON": "2025-10-15", "LAST REMINDER": [{date: "2025-11-01", comment: "Migration scheduled.", contactWith: "Ops Team"}], "STATUS": "Done"}
            ]
        };

        // --- KEY FIX: Renamed 'supabase' to 'supabaseClient' to avoid conflict ---
        let supabaseClient = null;
        let DB = {};
        let currentTable = null;
        let editIndex = -1;
        let reminderRowIndex = -1;
        let activeReminderCol = "";
        let isAdmin = localStorage.getItem('isPubaliAdmin') === 'true'; 
        let sortColumn = 'Last Reminder';
        let sortDirection = 'desc';
        const today = new Date();

        // ========== MOBILE SIDEBAR TOGGLE ==========
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 768 && sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        // ========== SUPABASE FUNCTIONS ==========
        
        async function initSupabase() {
            try {
                // Initialize the client
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                return true;
            } catch (error) {
                console.error('Supabase connection error:', error);
                alert('Database connection failed. Please check configuration.');
                return false;
            }
        }

        function openConfigModal() {
            if (!isAdmin) return;
            document.getElementById('supabaseUrl').value = SUPABASE_CONFIG.url;
            document.getElementById('supabaseKey').value = SUPABASE_CONFIG.key;
            document.getElementById('configScreen').style.display = 'flex';
        }

        function saveSupabaseConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                alert('Both URL and Key are required!');
                return;
            }
            
            alert('Configuration saved! Please update the SUPABASE_CONFIG in your code and redeploy.');
            closeModal('configScreen');
        }

        async function loadAllTablesFromDB() {
            try {
                const { data, error } = await supabaseClient
                    .from('pubali_tables')
                    .select('*');
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    await initializeStartupData();
                    return;
                }
                
                DB = {};
                data.forEach(row => {
                    DB[row.table_name] = row.data;
                });
                
                console.log('‚úÖ Loaded from Supabase:', Object.keys(DB));
            } catch (error) {
                console.error('Error loading from Supabase:', error);
                alert('Database load error: ' + error.message);
            }
        }

        async function initializeStartupData() {
            console.log('üì¶ Initializing startup data...');
            for (const [tableName, tableData] of Object.entries(STARTUP_DATA)) {
                await saveTableToDB(tableName, tableData);
            }
            DB = JSON.parse(JSON.stringify(STARTUP_DATA));
        }

        async function saveTableToDB(tableName, tableData) {
            try {
                const { data, error } = await supabaseClient
                    .from('pubali_tables')
                    .upsert({
                        table_name: tableName,
                        data: tableData,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'table_name' });
                
                if (error) throw error;
                console.log('‚úÖ Saved to DB:', tableName);
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                alert('Save error: ' + error.message);
            }
        }

        async function deleteTableFromDB(tableName) {
            try {
                const { error } = await supabaseClient
                    .from('pubali_tables')
                    .delete()
                    .eq('table_name', tableName);
                
                if (error) throw error;
                console.log('üóë Deleted from DB:', tableName);
            } catch (error) {
                console.error('Error deleting from Supabase:', error);
                alert('Delete error: ' + error.message);
            }
        }

        // ========== HELPER FUNCTIONS ==========

        function getLastReminderDate(row) {
            const remColName = Object.keys(row).find(k => k.toLowerCase().includes('last reminder'));
            if (remColName && Array.isArray(row[remColName]) && row[remColName].length > 0) {
                const dateStr = row[remColName][row[remColName].length - 1].date;
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        }

        // ========== INITIALIZATION ==========

        async function init() {
            const connected = await initSupabase();
            if (!connected) {
                document.getElementById('loadingScreen').style.display = 'none';
                return;
            }
            
            await loadAllTablesFromDB();
            applyAdminUI();
            renderSidebar();
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function applyAdminUI() {
            if (isAdmin) {
                document.querySelectorAll('.admin-only').forEach(el => el.style.setProperty('display', 'block', 'important'));
                document.getElementById('StatusIndicator').innerText = "Admin Mode (Live)";
                document.getElementById('StatusIndicator').style.color = "#00ff88";
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('StatusIndicator').innerText = "View Mode (Live)";
            }
        }

        // ========== RENDER LOGIC ==========

        function renderSidebar() {
            const list = document.getElementById('tableList');
            list.innerHTML = '';
            Object.keys(DB).forEach(key => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${key}</span> <small>(${DB[key].length})</small>`;
                if (key === currentTable) li.classList.add('active');
                li.onclick = () => {
                    loadTable(key);
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                };
                list.appendChild(li);
            });
        }

        function loadTable(tableName) {
            currentTable = tableName;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('tableContent').style.display = 'flex';
            document.getElementById('activeTableName').innerText = tableName;
            document.getElementById('searchInput').value = '';
            sortColumn = 'Last Reminder';
            sortDirection = 'desc';
            renderSidebar();
            renderRows();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderRows();
        }

        function renderRows() {
            const rows = DB[currentTable];
            const thead = document.getElementById('tableHeadRow');
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">No data found.</td></tr>';
                return;
            }

            let showCols = [];
            let truncCol = "";
            
            if (TABLE_CONFIG[currentTable]) {
                showCols = TABLE_CONFIG[currentTable].columns;
                truncCol = TABLE_CONFIG[currentTable].truncate;
            } else {
                showCols = Object.keys(rows[0]);
            }

            const filteredAndSortedRows = rows.slice().sort((a, b) => {
                let valA, valB;

                if (sortColumn.toLowerCase().includes('reminder')) {
                    valA = getLastReminderDate(a);
                    valB = getLastReminderDate(b);
                    
                    if (!valA && !valB) return 0;
                    if (!valA) return sortDirection === 'asc' ? 1 : -1;
                    if (!valB) return sortDirection === 'asc' ? -1 : 1;

                    const comparison = valA.getTime() - valB.getTime();
                    return sortDirection === 'asc' ? comparison : -comparison;
                } else {
                    valA = String(a[sortColumn] || '').toLowerCase();
                    valB = String(b[sortColumn] || '').toLowerCase();
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            showCols.forEach(col => {
                let style = (col === truncCol) ? 'style="width:50%"' : '';
                let sortIndicator = '';
                
                if (sortColumn === col) {
                    sortIndicator = `<span class="sort-indicator">${sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>`;
                }

                thead.innerHTML += `<th ${style} onclick="sortTable('${col}')">${col}${sortIndicator}</th>`;
            });
            thead.innerHTML += `<th style="text-align:center; width:100px;">Action</th>`;

            filteredAndSortedRows.forEach((row) => {
                const rowStr = JSON.stringify(row).toLowerCase();
                if (search && !rowStr.includes(search)) return;
                
                let trClass = '';
                const lastReminderDateObj = getLastReminderDate(row);
                let statusVal = (row['Status'] || row['STATUS'] || '').toLowerCase();
                
                if (statusVal !== 'done' && lastReminderDateObj) {
                    const diffTime = today.getTime() - lastReminderDateObj.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 10) trClass = 'overdue-row';
                }

                let tr = `<tr class="${trClass}">`;
                
                showCols.forEach(col => {
                    let val = row[col] || "";
                    let content = val;
                    const remColName = Object.keys(row).find(k => k.toLowerCase().includes('last reminder'));
                    const lastDate = (remColName && Array.isArray(row[remColName]) && row[remColName].length > 0) 
                        ? row[remColName][row[remColName].length - 1].date : null;

                    const originalIndex = DB[currentTable].findIndex(r => JSON.stringify(r) === JSON.stringify(row));

                    if (col === truncCol) {
                        content = `<span class="topic-truncate" title="Click to View Full Details" onclick="viewRowDetails(${originalIndex})">${val}</span>`;
                    } else if (col.toLowerCase().includes('last reminder')) {
                        content = `<span class="reminder-link" onclick="openReminderModal(${originalIndex}, '${col}')">${lastDate || "Add"}</span>`;
                    } else if (col.toLowerCase().includes('status') && statusVal === 'done') {
                        content = `<span class="Status-done">${val}</span>`;
                    }

                    tr += `<td>${content}</td>`;
                });

                const originalIndex = DB[currentTable].findIndex(r => JSON.stringify(r) === JSON.stringify(row));
                let actions = `<div class="action-icons">`;
                actions += `<button class="icon-btn" style="color:var(--primary);" title="View Details" onclick="viewRowDetails(${originalIndex})">üëÅÔ∏è</button>`;
                
                if (isAdmin) {
                    actions += `<button class="icon-btn" style="color:blue;" title="Edit" onclick="openRowModal('edit', ${originalIndex})">‚úé</button>`;
                    actions += `<button class="icon-btn" style="color:red;" title="Delete" onclick="deleteRow(${originalIndex})">üóë</button>`;
                }
                actions += `</div>`;

                tr += `<td>${actions}</td></tr>`;
                tbody.innerHTML += tr;
            });
        }

        // ========== VIEW DETAILS ==========

        function viewRowDetails(index) {
            const row = DB[currentTable][index];
            const tbody = document.getElementById('viewDetailsBody');
            tbody.innerHTML = '';

            Object.keys(row).forEach(key => {
                let val = row[key];
                
                if (key.toLowerCase().includes('last reminder') && Array.isArray(val)) {
                    if (val.length > 0) {
                        let history = val.map(r => `<strong>${r.date} (${r.contactWith || 'N/A'})</strong>: ${r.comment}`).join('<br>');
                        val = history;
                    } else {
                        val = "No reminders";
                    }
                }

                tbody.innerHTML += `<tr><th>${key}</th><td>${val}</td></tr>`;
            });

            document.getElementById('viewModal').style.display = 'flex';
        }

        // ========== EDIT/ADD LOGIC ==========

        function openRowModal(mode, index = -1) {
            if (!isAdmin) return;
            const modal = document.getElementById('mainModal');
            const form = document.getElementById('modalForm');
            const saveBtn = document.getElementById('modalSaveBtn');
            
            modal.style.display = 'flex';
            form.innerHTML = '';
            document.getElementById('modalTitle').innerText = mode === 'add' ? 'Add Entry' : 'Edit Entry';
            editIndex = index;

            const allColumns = Object.keys(DB[currentTable][0]);

            allColumns.forEach(col => {
                if (col.toLowerCase().includes('last reminder')) return;

                let val = mode === 'edit' ? DB[currentTable][index][col] : '';
                
                let isLong = (col.toLowerCase().includes('topic') || col.toLowerCase().includes('details') || col.toLowerCase().includes('comment'));
                let inputHtml = isLong 
                    ? `<textarea id="inp_${col}" rows="3">${val}</textarea>`
                    : `<input type="text" id="inp_${col}" value="${val}">`;

                form.innerHTML += `<div class="input-group"><label>${col}</label>${inputHtml}</div>`;
            });

            saveBtn.onclick = async () => {
                let newRow = mode === 'edit' ? DB[currentTable][editIndex] : JSON.parse(JSON.stringify(DB[currentTable][0]));
                
                allColumns.forEach(col => {
                    if (!col.toLowerCase().includes('last reminder')) {
                        let el = document.getElementById(`inp_${col}`);
                        if (el) newRow[col] = el.value;
                    } else if (mode === 'add') {
                        newRow[col] = [];
                    }
                });

                if (mode === 'add') {
                    DB[currentTable].push(newRow);
                } else {
                    DB[currentTable][editIndex] = newRow;
                }

                await saveTableToDB(currentTable, DB[currentTable]);
                renderRows();
                renderSidebar();
                closeModal('mainModal');
            };
        }

        async function deleteRow(index) {
            if (!confirm("Are you sure you want to delete this row?")) return;
            
            DB[currentTable].splice(index, 1);
            await saveTableToDB(currentTable, DB[currentTable]);
            renderRows();
            renderSidebar();
        }

        // ========== REMINDERS ==========

        function openReminderModal(rowIndex, colName) {
            reminderRowIndex = rowIndex;
            activeReminderCol = colName;
            const container = document.getElementById('reminderListContainer');
            container.innerHTML = '';

            const arr = DB[currentTable][rowIndex][colName] || [];
            
            if (arr.length === 0) {
                container.innerHTML = '<div style="color:#999; padding:10px;">No history.</div>';
            } else {
                [...arr].reverse().forEach(r => {
                    container.innerHTML += `
                        <div style="border-bottom:1px solid #eee; padding:8px 0;">
                            <div style="color:var(--primary); font-weight:bold; font-size:12px;">${r.date} <small>(${r.contactWith})</small></div>
                            <div style="color:#444; font-size:12px;">${r.comment}</div>
                        </div>`;
                });
            }

            document.getElementById('remDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('contactWith').value = '';
            document.getElementById('remComment').value = '';
            document.getElementById('reminderModal').style.display = 'flex';
        }

        async function addNewReminder() {
            const d = document.getElementById('remDate').value;
            const c = document.getElementById('remComment').value;
            const w = document.getElementById('contactWith').value;
            
            if (!d || !c) {
                alert("Date and Comment required");
                return;
            }

            if (!DB[currentTable][reminderRowIndex][activeReminderCol]) {
                DB[currentTable][reminderRowIndex][activeReminderCol] = [];
            }
            
            DB[currentTable][reminderRowIndex][activeReminderCol].push({ 
                date: d, 
                comment: c, 
                contactWith: w 
            });
            
            await saveTableToDB(currentTable, DB[currentTable]);
            openReminderModal(reminderRowIndex, activeReminderCol);
            renderRows();
        }

        // ========== TABLE MANAGEMENT ==========

        async function openAddTableModal() {
            const n = prompt("Enter new table name:");
            if (!n) return;
            
            if (DB[n]) {
                alert("Table already exists!");
                return;
            }
            
            DB[n] = [{
                "SL No.": 1,
                "Details": "",
                "Requested By": "",
                "Requested On": "",
                "Status": "",
                "Last Reminder": []
            }];
            
            await saveTableToDB(n, DB[n]);
            loadTable(n);
        }

        async function deleteCurrentTable() {
            if (!confirm(`Delete table "${currentTable}"? This cannot be undone!`)) return;
            
            await deleteTableFromDB(currentTable);
            delete DB[currentTable];
            
            currentTable = null;
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('tableContent').style.display = 'none';
            renderSidebar();
        }

        // ========== UTILITIES ==========

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function askAdminPass() {
            if (isAdmin) return;
            const pass = prompt("Enter Admin Password:");
            if (pass === "118" || pass === "123") {
                localStorage.setItem('isPubaliAdmin', 'true');
                location.reload();
            }
        }

        async function exportData() {
            const dataStr = JSON.stringify(DB, null, 2);
            const blob = new Blob([`const STARTUP_DATA = ${dataStr};`], { type: "text/javascript" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `pubali_backup_${new Date().toISOString().split('T')[0]}.js`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ========== START APPLICATION ==========
        init();
    </script>
</body>
</html>
